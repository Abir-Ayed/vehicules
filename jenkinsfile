pipeline {
    agent any

    environment {
        // Set AWS credentials and region
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_REGION = 'us-east-1' 
        S3_BUCKET = 'vehicules'
        LAMBDA_FUNCTION_NAME = 'ExtractJsonFunction'
        LAMBDA_SOURCE_CODE_PATH = 'lambda-function' 
    }

    stages {
        stage('Clone Repository') {
            steps {
                // Clone your source code repository
                git url: 'https://github.com/Abir-Ayed/vehicules.git', branch: 'master'
            }
        }


        stage('Package Lambda Function') {
            steps {
                script {
                    // Package the Lambda function code
                    sh "zip -r function.zip ${LAMBDA_SOURCE_CODE_PATH}"
                }
            }
        }

        stage('Deploy Lambda Function') {
            steps {
                script {
                    // Deploy the Lambda function
                    sh "aws lambda update-function-code --function-name ${LAMBDA_FUNCTION_NAME} --zip-file fileb://function.zip"
                }
            }
        }

        stage('Invoke Lambda Function') {
            steps {
                script {
                    // Invoke the Lambda function
                    sh "aws lambda invoke --function-name ${LAMBDA_FUNCTION_NAME} response.json"
                    // Log the response
                    sh "cat response.json"
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline executed successfully. The JSON file is uploaded, and the Lambda function is deployed and invoked.'
        }
        failure {
            echo 'Pipeline failed. Check the logs for details.'
        }
    }
}
